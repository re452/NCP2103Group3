@page "/"
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using PawGress.Data
@using PawGress.Models
@using PawGress.Services
@inject UserService UserService
@inject PetService PetService
@inject NavigationManager Navigation

<!-- Pixelated font -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />

<div class="auth-card">
    <EditForm Model="@loginUser" OnValidSubmit="HandleLogin" FormName="loginForm">
        <h1 class="auth-title">LOGIN</h1>

        <InputText @bind-Value="loginUser.Username" placeholder="Username" class="auth-input" />
        <InputText @bind-Value="loginUser.Password" type="password" placeholder="Password" class="auth-input" />

        <button type="submit" class="auth-button" disabled="@isSubmitting">
            @(isSubmitting ? "Checking..." : "Login")
        </button>

        <p class="auth-footer">
            Don't have an account? <a href="/signup">Sign up</a>
        </p>

        @if (!string.IsNullOrEmpty(message))
        {
            <p class="auth-message">@message</p>
        }
    </EditForm>
</div>

<style>
    /* --- Global Pixel Font --- */
    * {
        font-family: 'Press Start 2P', cursive;
        box-sizing: border-box;
    }

    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        background-image: url('/Images/pixel.png');
        color: #fff;
    }

    /* --- Auth Card --- */
    .auth-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
    }

    form {
        background-color: #36274f;
        padding: 30px 20px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        width: 300px;
    }

    .auth-title {
        font-size: 1rem; /* small because pixel font is large visually */
        margin-bottom: 10px;
        text-align: center;
        color: #3ee6c8;
    }

    /* --- Inputs --- */
    .auth-input {
        width: 100%;
        padding: 8px;
        border: 2px solid #3ee6c8;
        border-radius: 6px;
        background-color: #4f3973;
        color: #fff;
        font-family: 'Press Start 2P', cursive;
    }

    .auth-input::placeholder {
        color: #bbb;
    }

    /* --- Button --- */
    .auth-button {
        width: 100%;
        padding: 8px;
        border: none;
        border-radius: 6px;
        background-color: #3ee6c8;
        color: #000;
        cursor: pointer;
        font-family: 'Press Start 2P', cursive;
        transition: background 0.2s;
    }

    .auth-button:disabled {
        background-color: #7fc9bf;
        cursor: not-allowed;
    }

    .auth-button:hover:not(:disabled) {
        background-color: #36cbb0;
    }

    /* --- Footer & links --- */
    .auth-footer {
        font-size: 0.6rem;
        text-align: center;
    }

    .auth-footer a {
        color: #3ee6c8;
        text-decoration: none;
    }

    .auth-footer a:hover {
        text-decoration: underline;
    }

    /* --- Message text --- */
    .auth-message {
        font-size: 0.6rem;
        text-align: center;
        color: #ff4c4c;
    }
</style>

@code {
    private User loginUser = new();
    private string message = string.Empty;
    private bool isSubmitting = false;

    private async Task HandleLogin()
    {
        try
        {
            isSubmitting = true;
            message = string.Empty;
            StateHasChanged();

            if (string.IsNullOrWhiteSpace(loginUser.Username) ||
                string.IsNullOrWhiteSpace(loginUser.Password))
            {
                message = "⚠️ Please enter both username and password.";
                return;
            }

            var existingUser = await UserService.AuthenticateAsync(loginUser.Username, loginUser.Password);
            if (existingUser == null)
            {
                message = "❌ Invalid username or password.";
                return;
            }

            var pets = await PetService.GetUserPetsAsync(existingUser.Id);

            message = $"✅ Welcome back, {existingUser.Username}!";
            StateHasChanged();
            await Task.Delay(800);

            Navigation.NavigateTo("/dashboard", forceLoad: true);
        }
        catch (Exception ex)
        {
            message = $"❌ Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
