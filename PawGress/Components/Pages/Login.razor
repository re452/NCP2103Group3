@page "/"
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using PawGress.Data
@using PawGress.Models
@using PawGress.Services
@inject UserService UserService
@inject PetService PetService
@inject NavigationManager Navigation

<link href="app.css" rel="stylesheet" />
<link href="auth.css" rel="stylesheet" />

<div class="auth-card" style="color:white">
    <EditForm Model="@loginUser" OnValidSubmit="HandleLogin" FormName="loginForm">
        <h1 class="auth-title">LOGIN</h1>

        <InputText @bind-Value="loginUser.Username" placeholder="Username" class="auth-input" />
        <InputText @bind-Value="loginUser.Password" type="password" placeholder="Password" class="auth-input" />

        <button type="submit" class="auth-button" disabled="@isSubmitting">
            @(isSubmitting ? "Checking..." : "Login")
        </button>

        <p style="color:white">
            Don't have an account? <a href="/signup" style="color:#3ee6c8">Sign up</a>
        </p>

        @if (!string.IsNullOrEmpty(message))
        {
            <p style="color:white">@message</p>
        }
    </EditForm>
</div>

@code {
    private User loginUser = new();
    private string message = string.Empty;
    private bool isSubmitting = false;

    private async Task HandleLogin()
    {
        try
        {
            isSubmitting = true;
            message = string.Empty;
            StateHasChanged();

            // 1️⃣ Empty field check
            if (string.IsNullOrWhiteSpace(loginUser.Username) ||
                string.IsNullOrWhiteSpace(loginUser.Password))
            {
                message = "⚠️ Please enter both username and password.";
                return;
            }

            // 2️⃣ Authenticate user
            var existingUser = await UserService.AuthenticateAsync(loginUser.Username, loginUser.Password);
            if (existingUser == null)
            {
                message = "❌ Invalid username or password.";
                return;
            }

            // 3️⃣ Ensure user has starter pets (handled automatically in PetService)
            var pets = await PetService.GetUserPetsAsync(existingUser.Id);

            // 4️⃣ Success
            message = $"✅ Welcome back, {existingUser.Username}!";
            StateHasChanged();
            await Task.Delay(800);

            // Redirect to "Your Pets" page
            Navigation.NavigateTo("/dashboard", forceLoad: true);
        }
        catch (Exception ex)
        {
            message = $"❌ Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
