@page "/signup"
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using PawGress.Models
@using PawGress.Data
@inject NavigationManager Navigation
@inject AppDbContext Db

<!-- Pixelated font -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />

<div class="auth-card">
    <form @onsubmit="HandleSignup" @onsubmit:preventDefault>
        <h1 class="auth-title">SIGN UP</h1>

        <input @bind="signupUser.Username" placeholder="Username" class="auth-input" />
        <input @bind="signupUser.Password" type="password" placeholder="Password" class="auth-input" />
        <input @bind="confirmPassword" type="password" placeholder="Confirm Password" class="auth-input" />

        <button type="submit" class="auth-button" disabled="@isSubmitting">
            @(isSubmitting ? "Creating account..." : "Sign Up")
        </button>

        <p class="auth-footer">
            Already have an account? <a href="/">Login</a>
        </p>

        @if (!string.IsNullOrEmpty(message))
        {
            <p class="auth-message">@message</p>
        }
    </form>
</div>

<style>
    /* --- Global Pixel Font --- */
    * {
        font-family: 'Press Start 2P', cursive;
        box-sizing: border-box;
    }

    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        background-image: url('/Images/pixel.png');
        color: #fff;
    }

    /* --- Auth Card --- */
    .auth-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
    }

    form {
        background-color: #36274f;
        padding: 30px 20px;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        width: 300px;
    }

    .auth-title {
        font-size: 1rem;
        margin-bottom: 10px;
        text-align: center;
        color: #3ee6c8;
    }

    /* --- Inputs --- */
    .auth-input {
        width: 100%;
        padding: 8px;
        border: 2px solid #3ee6c8;
        border-radius: 6px;
        background-color: #4f3973;
        color: #fff;
        font-family: 'Press Start 2P', cursive;
    }

    .auth-input::placeholder {
        color: #bbb;
    }

    /* --- Button --- */
    .auth-button {
        width: 100%;
        padding: 8px;
        border: none;
        border-radius: 6px;
        background-color: #3ee6c8;
        color: #000;
        cursor: pointer;
        font-family: 'Press Start 2P', cursive;
        transition: background 0.2s;
    }

    .auth-button:disabled {
        background-color: #7fc9bf;
        cursor: not-allowed;
    }

    .auth-button:hover:not(:disabled) {
        background-color: #36cbb0;
    }

    /* --- Footer & links --- */
    .auth-footer {
        font-size: 0.6rem;
        text-align: center;
    }

    .auth-footer a {
        color: #3ee6c8;
        text-decoration: none;
    }

    .auth-footer a:hover {
        text-decoration: underline;
    }

    /* --- Message text --- */
    .auth-message {
        font-size: 0.6rem;
        text-align: center;
        color: #ff4c4c;
    }
</style>

@code {
    private User signupUser = new();
    private string confirmPassword = string.Empty;
    private string message = string.Empty;
    private bool isSubmitting = false;

    private async Task HandleSignup()
    {
        try
        {
            isSubmitting = true;
            message = string.Empty;
            StateHasChanged();

            if (string.IsNullOrWhiteSpace(signupUser.Username) ||
                string.IsNullOrWhiteSpace(signupUser.Password) ||
                string.IsNullOrWhiteSpace(confirmPassword))
            {
                message = "⚠️ All fields are required.";
                isSubmitting = false;
                return;
            }

            if (signupUser.Password != confirmPassword)
            {
                message = "⚠️ Passwords do not match.";
                isSubmitting = false;
                return;
            }

            var existing = await Db.Users.FirstOrDefaultAsync(u => u.Username == signupUser.Username);
            if (existing != null)
            {
                message = "⚠️ Username already exists.";
                isSubmitting = false;
                return;
            }

            Db.Users.Add(signupUser);
            await Db.SaveChangesAsync();

            message = $"✅ Account created for: {signupUser.Username}";
            StateHasChanged();
            await Task.Delay(800);

            Navigation.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            message = $"❌ Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
