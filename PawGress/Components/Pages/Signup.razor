@page "/signup"
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using PawGress.Models
@using PawGress.Data
@inject NavigationManager Navigation
@inject AppDbContext Db

<link href="app.css" rel="stylesheet" />
<link href="auth.css" rel="stylesheet" />

<div class="auth-card" style="color:white">
    <!-- use Blazor onsubmit and prevent the browser default -->
    <form @onsubmit="HandleSignup" @onsubmit:preventDefault>
        <h1 class="auth-title">SIGN UP</h1>

        <input @bind="signupUser.Username" placeholder="Username" class="auth-input" />
        <input @bind="signupUser.Password" type="password" placeholder="Password" class="auth-input" />
        <input @bind="confirmPassword" type="password" placeholder="Confirm Password" class="auth-input" />

        <button type="submit" class="auth-button" disabled="@isSubmitting">
            @(isSubmitting ? "Creating account..." : "Sign Up")
        </button>

        <p style="color:white">
            Already have an account? <a href="/" style="color:#3ee6c8">Login</a>
        </p>

        @if (!string.IsNullOrEmpty(message))
        {
            <p style="color:white">@message</p>
        }
    </form>
</div>

@code {
    private User signupUser = new();
    private string confirmPassword = string.Empty;
    private string message = string.Empty;
    private bool isSubmitting = false;

    private async Task HandleSignup()
    {
        try
        {
            isSubmitting = true;
            message = string.Empty;
            StateHasChanged();

            // Basic validation
            if (string.IsNullOrWhiteSpace(signupUser.Username) ||
                string.IsNullOrWhiteSpace(signupUser.Password) ||
                string.IsNullOrWhiteSpace(confirmPassword))
            {
                message = "⚠️ All fields are required.";
                isSubmitting = false;
                return;
            }

            // Password confirmation check
            if (signupUser.Password != confirmPassword)
            {
                message = "⚠️ Passwords do not match.";
                isSubmitting = false;
                return;
            }

            // Check duplicate username
            var existing = await Db.Users.FirstOrDefaultAsync(u => u.Username == signupUser.Username);
            if (existing != null)
            {
                message = "⚠️ Username already exists.";
                isSubmitting = false;
                return;
            }

            // Save user
            Db.Users.Add(signupUser);
            await Db.SaveChangesAsync();

            message = $"✅ Account created for: {signupUser.Username}";
            StateHasChanged();

            await Task.Delay(800);

            // Redirect to login
            Navigation.NavigateTo("/", forceLoad: true);
        }
        catch (Exception ex)
        {
            message = $"❌ Error: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
